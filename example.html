<!DOCTYPE html>
<html>
<head>
	<title>Virtual simulator</title>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<script type="text/javascript">
	 
	function Obj(){
		this.url = null;
		this.x = 0;
		this.y = 0;
		this.w = 50;
		this.h = 50;
		this.deg = 0;
		this.fill = "#444444";
		this.id = -1;
		this.contains= function(mx, my) {
		  // All we have to do is make sure the Mouse X,Y fall in the area between
		  // the shape's X and (X + Height) and its Y and (Y + Height)
		  return  (this.x <= mx) && (this.x + this.w >= mx) &&
		          (this.y <= my) && (this.y + this.h >= my);
		}
	}
	
	var count = 0
	var MyObj = []; // array of objects
	
	function addObj(url,x,y,w,h,deg,fill){
		var myObj = new Obj;
		myObj.url = url;
		myObj.x = x;
		myObj.y = y;
		myObj.w = w;
		myObj.h = h;
		myObj.deg = deg;
		myObj.fill = fill;
		myObj.id = count;
		MyObj.push(myObj);
		invalidate();
		var jaffa = "";
		for(var y = 0; y< count; y++){
			jaffa += " " + MyObj[y].url;
		}
		//alert(jaffa);
		count++;
	}
	
	
	
	var canvas; // basic vars
	var ctx;
	var WIDTH;
	var HEIGHT;
	var INTERVAL = 20;  
	
	var isDrag = false;
	var mx, my; // mouse coordinates
	
	var canvasValid = false;
	
	var mySel; // my selction
	
	var mySelColor = '#CC0000'; // selction border & color
	var mySelWidth = 1;
	
	var ghostcanvas; // dummy canvas
	var gctx;
	
	var offsetx, offsety; // offset for mouse click
	
	var stylePaddingLeft, stylePaddingTop, styleBorderLeft, styleBorderTop;
	
	function init(){
		
		canvas = document.getElementById('canvas');
		HEIGHT = canvas.height;
		WIDTH = canvas.width;
		ctx = canvas.getContext('2d');
		//ghostcanvas = document.createElement('canvas');
		//ghostcanvas.height = HEIGHT;
		//ghostcanvas.width = WIDTH;
		//gctx = ghostcanvas.getContext('2d');
		
		canvas.onselectstart = function () { return false; }
		
		if (document.defaultView && document.defaultView.getComputedStyle) {
		    stylePaddingLeft = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingLeft'], 10)      || 0;
		    stylePaddingTop  = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingTop'], 10)       || 0;
		    styleBorderLeft  = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderLeftWidth'], 10)  || 0;
		    styleBorderTop   = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderTopWidth'], 10)   || 0;
		  }
		
		
		
		setInterval(draw, INTERVAL);
		
		canvas.onmousedown = myDown;
		canvas.onmouseup = myUp;
		//canvas.ondblclick = myDblClick;
		 
		//drawGrid();
		addObj("beaker.png",10,10,100,100,0,"#eee");
		
		
	}
	
	function drawGrid(){
		for (var x = 0.5; x < WIDTH; x += 5) {
			  ctx.moveTo(x, 0);
			  ctx.lineTo(x, HEIGHT);
			}
			
		for (var y = 0.5; y < HEIGHT; y += 5) {
			  ctx.moveTo(0, y);
			  ctx.lineTo(WIDTH, y );
			}
		ctx.strokeStyle="#eee";
		ctx.stroke();
	}
	
	function clear(c) {
		  c.clearRect(0, 0, WIDTH, HEIGHT);
		  //drawGrid();
	}
	
	function draw() {
		  if (canvasValid == false) {
		    clear(ctx);
		    
		    var l = MyObj.length;
		    for (var i = 0; i < l; i++) {
		        //drawshape(ctx, boxes[i], boxes[i].fill);
		        drawObj(ctx,MyObj[i]);
		    }
		    
		    if (mySel != null) {
		      ctx.strokeStyle = mySelColor;
		      //ctx.lineWidth = mySelWidth;
		      ctx.strokeRect(mySel.x,mySel.y,mySel.w,mySel.h);
		    }
		    
		    
		    canvasValid = true;
		  }
	}
	
	function drawObj(context, shape) {
		  
		  if (shape.x > WIDTH || shape.y > HEIGHT) return; 
		  if (shape.x + shape.w < 0 || shape.y + shape.h < 0) return;
		  
		  
		  //console.log("")
		  var base_image = new Image();
		 // base_image.src = ""; 
		  base_image.src = shape.url;
		  base_image.onload = function(){
			 // alert("Drawing - " + base_image.src + " -- " + shape.url);
		    ctx.drawImage(base_image, shape.x, shape.y);
		  }
		  
		  //context.fillRect(shape.x,shape.y,100,100);
	}
	
	function myMove(e){
		  //alert(mx+my);
		  if (isDrag){
		    getMouse(e);
		    
		    mySel.x = mx - offsetx;
		    mySel.y = my - offsety;   
		    
		    invalidate();
		  }
	}
	
	// Happens when the mouse is clicked in the canvas
	function myDown(e){
	  getMouse(e);
	  //clear(gctx);
	  
	  var l = MyObj.length;
	  for (var i = 0; i < l; i++) {
		  
	    //drawObj(gctx,MyObj[i]);
	    
	    // get image data at the mouse x,y pixel
	   // var imageData = gctx.getImageData(mx, my, 1, 1);
	    //var index = (mx + my * imageData.width);// * 4;
	    
	    //alert(imageData.width+" " + my + " " + mx);
	    
	    //alert(imageData.data.length);
	    //alert(st);
	    // if the mouse pixel exists, select and break
	    
	    //alert(mx+" " + my);
	    if (MyObj[i].contains(mx,my)) {
	      mySel = MyObj[i];
	      offsetx = mx - mySel.x;
	      offsety = my - mySel.y;
	      mySel.x = mx - offsetx;
	      mySel.y = my - offsety;
	      isDrag = true;
	      canvas.onmousemove = myMove;
	      invalidate();
	      clear(ctx);
	      return;
	    }
	    
	  }
	  
	  mySel = null;
	  clear(ctx);
	  invalidate();
	}

	function myUp(){
	  isDrag = false;
	  canvas.onmousemove = null;
	}
	
	function invalidate() {
		  canvasValid = false;
	}
	
	function getMouse(e) {
	      var element = canvas, offsetX = 0, offsetY = 0;

	      if (element.offsetParent) {
	        do {
	          offsetX += element.offsetLeft;
	          offsetY += element.offsetTop;
	        } while ((element = element.offsetParent));
	      }

	      offsetX += stylePaddingLeft;
	      offsetY += stylePaddingTop;

	      offsetX += styleBorderLeft;
	      offsetY += styleBorderTop;

	      mx = e.pageX - offsetX;
	      my = e.pageY - offsetY
	      
	      
	}
		
	function addItem(){
		
		//alert(ctx);
		addObj("jar.png",410,410,100,100,0,"#eee");
	}
	</script>
</head>
<body onload="init();">

	<h4 align="center">Virtual Lab Simulator v1.0</h4>
  	<table border="0" width="100%">
  		<tr>
  			<td width="80%"> <canvas id="canvas" width="1020%" height="550" style="border:2px solid #eee;"></canvas> </td>
  			<td width="20%" valign="top" style="padding:10px;padding-left:5px;border-left:2px solid #eee;">
  				<h5 style="padding-left:8px;margin-top:-5px;border-bottom:2px solid #eee;">Tool bar</h5>
  				<button onclick="addItem();">Add Item</button>
  				<button onclick="clear();">Clear</button>
  			</td>
  		</tr>
  		
  	</table>
</body>
</html>
