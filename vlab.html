<html>

<head>
<!--Virtual labs 10:00 18 July 2014-->
</head>

<style>

*{
	padding: 0px;
	margin: 0px;
}

body{
	background-color: #000000;
}

#canvas{
	background-color: #FFFFFF;
	border: 2px solid black;
	border-radius: 20px;
}

#pics{
	background-color: red;
	overflow: scroll;
	overflow-x: hidden;
}

</style>

<body>
<button onclick="genCSV();">Genarate CSV</button>
<button onclick="loadCSV();">Load CSV</button>
<div id="pics">
<table width="200" border="2">
	<tr>
		<td width="100"><img id="img1" src="android.png" height="100px" width="100px" onclick="createobj(1);" /></td>
		<td width="100"><img id="img2" src="android2.png" height="100px" width="100px" onclick="createobj(2);" /></td>
	</tr>
	<tr> 
		<td width="100"><img id="img3" src="android3.png" height="100px" width="100px" onclick="createobj(3);" /></td>
		<td width="100"><img id="img4" src="android4.png" height="100px" width="100px" onclick="createobj(4);" /></td>
	</tr>
	<tr>
		<td width="100"><img id="img5" src="android.png" height="100px" width="100px" onclick="createobj(5);" /></td>
		<td width="100"><img id="img6" src="android2.png" height="100px" width="100px" onclick="createobj(6);" /></td>
	</tr>
	<tr> 
		<td width="100"><img id="img7" src="android3.png" height="100px" width="100px" onclick="createobj(7);" /></td>
		<td width="100"><img id="img8" src="android4.png" height="100px" width="100px" onclick="createobj(8);" /></td>
	</tr>
	<tr>
		<td width="100"><img id="img9" src="android.png" height="100px" width="100px" onclick="createobj(9);" /></td>
		<td width="100"><img id="img10" src="android2.png" height="100px" width="100px" onclick="createobj(10);" /></td>
	</tr>
	<tr> 
		<td width="100"><img id="img11" src="android3.png" height="100px" width="100px" onclick="createobj(11);" /></td>
		<td width="100"><img id="img12" src="android4.png" height="100px" width="100px" onclick="createobj(12);" /></td>
	</tr>
</table>
</div>
<canvas id="canvas"> 
</canvas>

<script>

var change_mode = -1;
var current_img = -1;
var current_id = 0;
////
var img1 = document.getElementById('img1');
var img2 = document.getElementById('img2');
var img3 = document.getElementById('img3');
var img4 = document.getElementById('img4');
var img5 = document.getElementById('img5');
var img6 = document.getElementById('img6');
var img7 = document.getElementById('img7');
var img8 = document.getElementById('img8');
var img9 = document.getElementById('img9');
var img10 = document.getElementById('img10');
var img11 = document.getElementById('img11');
var img12 = document.getElementById('img12');
////

var picTable = document.getElementById('pics');
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var csvString = "";

canvas.width = window.innerWidth*0.8;
canvas.height = window.innerHeight*0.85;
canvas.style.position = "absolute";

picTable.style.height = canvas.height;
picTable.style.width = 226;
var offsetX = (window.innerWidth - canvas.width - 226)/2;
var offsetY = (window.innerHeight - canvas.height)/2;
canvas.style.left = offsetX;
canvas.style.top = offsetY;

picTable.style.position = "absolute";
picTable.style.left = offsetX + 4 + canvas.width;
picTable.style.top = offsetY;

var pic_obj = [];

function object(id,x,y,a,ow,oh,fw,fh) {
	this.id = id; //picture id
	this.x = x; //x coord
	this.y = y; //y coord
	this.a = a; //angle deg
	this.ow = ow; //original width
	this.oh = oh; //original height
	this.fw = fw; //final width
	this.fh = fh; //final height
}

//pic_obj.push(new object(1,100,100,0,100,100,100,100));

canvas.addEventListener("mousemove",move_img);
canvas.addEventListener("mousedown",findobj);
canvas.addEventListener("mouseup",finish_transform);
window.addEventListener("keydown",zoom_rotate);

function drawcanvas() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
	for(var i=0;i<pic_obj.length;i++) {
		if(pic_obj[i].a == 0) 
			ctx.drawImage(document.getElementById("img"+pic_obj[i].id),pic_obj[i].x,pic_obj[i].y,pic_obj[i].fw,pic_obj[i].fh);
		else {
			ctx.save();
			ctx.translate(pic_obj[i].x+pic_obj[i].fw/2,pic_obj[i].y+pic_obj[i].fh/2);
			ctx.rotate(pic_obj[i].a*Math.PI/180);
			ctx.drawImage(document.getElementById("img"+pic_obj[i].id),-1*pic_obj[i].fw/2,-1*pic_obj[i].fh/2,pic_obj[i].fw,pic_obj[i].fh);
			ctx.restore();
		}
	}
	/*ctx.drawImage(img1,canvas.width - 110,0,100,100);
	ctx.drawImage(img2,canvas.width - 110,100,100,100);
	ctx.drawImage(img3,canvas.width - 110,200,100,100);
	ctx.drawImage(img4,canvas.width - 110,300,100,100);
	ctx.moveTo(canvas.width - 120,0);
	ctx.lineTo(canvas.width - 120,canvas.height);
	ctx.stroke();*/
}

function finish_transform() {
	if(change_mode == 0) {
		var perX = parseInt(pic_obj[current_img].x/canvas.width*100);
		var perY = parseInt(pic_obj[current_img].y/canvas.height*100);
		csvString += perX + "," + perY + "\n";	
	} else if(change_mode == 1) {
		var scaling = parseInt(pic_obj[current_img].fh/canvas.height*100);
		var cimg = current_img+1;
		csvString += "s," + cimg + "," + scaling + "\n";
	} else if(change_mode == 2) {
		var cimg = current_img+1;
		csvString += "r," + cimg + "," + pic_obj[current_img].a + "\n";
	}

	current_img = -1;
	change_mode = -1;
}

function move_img(e) {
	
	if(current_img != -1 && (change_mode == -1 || change_mode == 0)) {
		if(change_mode == -1) { 
			var perX = parseInt(pic_obj[current_img].x/canvas.width*100);
			var perY = parseInt(pic_obj[current_img].y/canvas.height*100);
			var cimg = current_img+1;
			csvString += "m," + cimg + "," + perX + "," + perY + ",";
		}
	///////////
	change_mode = 0;
	///////////
	pic_obj[current_img].x = (e.clientX - offsetX) - pic_obj[current_img].fw/2;
	pic_obj[current_img].y = (e.clientY - offsetY) - pic_obj[current_img].fh/2;
	drawcanvas();
	}
}

function zoom_rotate(e) {
	//console.log(e.keyCode);
	if(current_img != -1) {
		if(e.keyCode == 107 && (change_mode == -1 || change_mode == 1)) {
			////////////
			change_mode = 1;
			////////////
			pic_obj[current_img].fw += 2;
			pic_obj[current_img].fh += 2;
		} else if(e.keyCode == 109 && (change_mode == -1 || change_mode == 1)){
			////////////
			change_mode = 1;
			////////////
			pic_obj[current_img].fw -= 2;
			pic_obj[current_img].fh -= 2;
		} else if(e.keyCode == 39 && (change_mode == -1 || change_mode == 2)) {
			////////////
			change_mode = 2;
			////////////
			pic_obj[current_img].a += 2;
		} else if(e.keyCode == 37 && (change_mode == -1 || change_mode == 2)) {
			////////////
			change_mode = 2;
			////////////
			pic_obj[current_img].a -= 2;
		}

	drawcanvas();
	}
}

function findobj(e) {
	for(var i=0;i<pic_obj.length;i++)
		if((e.clientX - offsetX)  >= pic_obj[i].x && (e.clientX - offsetX) <= (pic_obj[i].x+pic_obj[i].fw) && (e.clientY - offsetY) >= pic_obj[i].y && (e.clientY - offsetY) <= (pic_obj[i].y+pic_obj[i].fh)) {
			current_img = i;
			break;
		}	
}

/*function createobj(e) {
	
	if((e.clientX - offsetX) > canvas.width-110) {
		current_id = parseInt((e.clientY - offsetY)/100);
		console.log(current_id);
		pic_obj.push(new object(current_id+1,100,100,0,100,100,100,100));
		///////
		csvString += "a," + current_id + "," + pic_obj.length + "\n";
		///////
		drawcanvas();
	}
}*/

function createobj(picid) {
	pic_obj.push(new object(picid,100,100,0,100,100,100,100));
	///////
	csvString += "a," + current_id + "," + pic_obj.length + "\n";
	///////
	drawcanvas();
}

function waste() {
	//ctx.clearRect(0,0,canvas.width,canvas.height);
	ctx.drawImage(img1,canvas.width - 110,0,100,100);
	ctx.drawImage(img2,canvas.width - 110,100,100,100);
	ctx.drawImage(img3,canvas.width - 110,200,100,100);
	ctx.drawImage(img4,canvas.width - 110,300,100,100);
	ctx.moveTo(canvas.width - 120,0);
	ctx.lineTo(canvas.width - 120,canvas.height);
	ctx.stroke();
}

		var xmlHttp;
function init_ajax(){
	
		if(window.ActiveXObject){
			try{xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");}
			catch (e){xmlHttp = false;}
		}
		else{
			try{xmlHttp = new XMLHttpRequest();}
			catch (e){xmlHttp = false;}
		}
	}
		
function genCSV(){
		
		init_ajax();
		if(!xmlHttp){
			console.log('xmlhttp not working ...');
		}
		else {
			xmlHttp.onreadystatechange=function(){
			  if (xmlHttp.readyState==4 && xmlHttp.status==200){
				console.log(xmlHttp.responseText);
				}
			  else {
			  }
			 }
			 
			var data = "data="+csvString;
			xmlHttp.open("POST","create.php",true);
			xmlHttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			xmlHttp.setRequestHeader("Content-length",data.length);
			xmlHttp.setRequestHeader("Connection","close");
			xmlHttp.send(data);
		}
		
	}

function loadCSV(){
		
		init_ajax();
		if(!xmlHttp){
			console.log('xmlhttp not working ...');
		}
		else {
			xmlHttp.onreadystatechange=function(){
			  if (xmlHttp.readyState==4 && xmlHttp.status==200){
					csvString = xmlHttp.responseText;
				}
			  else {
			  }
			 }
			 
			xmlHttp.open("GET","display.php",true);
			xmlHttp.send();
		}
		
	}
</script>


</body>
</html>
