<html>

<head>
<!--Virtual labs 10:00 18 July 2014-->
</head>

<style>

*{
	padding: 0px;
	margin: 0px;
}

body{
	background-color: #000000;
}

#canvas{
	background-color: #FFFFFF;
	border: 2px solid black;
	border-radius: 20px;		
}

</style>


<body>

<canvas id="canvas"> 
</canvas>
<img id="img1" src="android.png" style="display:none" />
<img id="img2" src="android2.png" style="display:none" />

<script>

var change_mode = -1;
var current_img = -1;
var current_id = 0;
////
var img1 = document.getElementById('img1');
var img2 = document.getElementById('img2');
////

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var csvString = "";

canvas.width = window.innerWidth*0.9;
canvas.height = window.innerHeight*0.85;
canvas.style.position = "absolute";
var offsetX = (window.innerWidth - canvas.width)/2;
var offsetY = (window.innerHeight - canvas.height)/2;
canvas.style.left = offsetX;
canvas.style.top = offsetY;

var pic_obj = [];

function object(id,x,y,a,ow,oh,fw,fh) {
	this.id = id; //picture id
	this.x = x; //x coord
	this.y = y; //y coord
	this.a = a; //angle deg
	this.ow = ow; //original width
	this.oh = oh; //original height
	this.fw = fw; //final width
	this.fh = fh; //final height
}

//pic_obj.push(new object(1,100,100,0,100,100,100,100));

canvas.addEventListener("mousemove",function(){if(current_img != -1) {
	if(change_mode == -1) { 
	var perX = parseInt(pic_obj[current_img].x/canvas.width*100);
	var perY = parseInt(pic_obj[current_img].y/canvas.height*100);
	csvString += "m," + current_img + "," + perX + "," + perY + ",";}
	move_img(event);}});
canvas.addEventListener("mousedown",function(){findobj(event);});
canvas.addEventListener("mouseup",finish_transform);
canvas.addEventListener("click",createobj);
window.addEventListener("keydown",function(){if(current_img != -1) zoom_rotate(event);});

function drawcanvas() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
	for(var i=0;i<pic_obj.length;i++) {
		if(pic_obj[i].a == 0) 
			ctx.drawImage(document.getElementById("img"+pic_obj[i].id),pic_obj[i].x,pic_obj[i].y,pic_obj[i].fw,pic_obj[i].fh);
		else {
			ctx.save();
			ctx.translate(pic_obj[i].x+pic_obj[i].fw/2,pic_obj[i].y+pic_obj[i].fh/2);
			ctx.rotate(pic_obj[i].a*Math.PI/180);
			ctx.drawImage(document.getElementById("img"+pic_obj[i].id),-1*pic_obj[i].fw/2,-1*pic_obj[i].fh/2,pic_obj[i].fw,pic_obj[i].fh);
			ctx.restore();
		}
	}
	/////
	ctx.drawImage(img1,canvas.width - 110,0,100,100);
	ctx.drawImage(img2,canvas.width - 110,100,100,100);
	ctx.moveTo(canvas.width - 120,0);
	ctx.lineTo(canvas.width - 120,canvas.height);
	ctx.stroke();
	/////
}

function finish_transform() {
	if(change_mode == 0) {
		var perX = parseInt(pic_obj[current_img].x/canvas.width*100);
		var perY = parseInt(pic_obj[current_img].y/canvas.height*100);
		csvString += perX + "," + perY + "\n";	
	} else if(change_mode == 1) {
		var scaling = parseInt(pic_obj[current_img].fh/canvas.height*100);
		csvString += "s," + current_img + "," + scaling + "\n";
	} else if(change_mode == 2) {
		csvString += "r," + current_img + "," + pic_obj[current_img].a + "\n";
	}

	current_img = -1;
	change_mode = -1;
}

function move_img(e) {
	console.log("1");
	///////////
	change_mode = 0;
	///////////
	pic_obj[current_img].x = (e.clientX - offsetX) - pic_obj[current_img].fw/2;
	pic_obj[current_img].y = (e.clientY - offsetY) - pic_obj[current_img].fh/2;
	drawcanvas();
}

function zoom_rotate(e) {
	//console.log(e.keyCode);
	if(e.keyCode == 107) {
		////////////
		change_mode = 1;
		////////////
		pic_obj[current_img].fw += 2;
		pic_obj[current_img].fh += 2;
	} else if(e.keyCode == 109){
		////////////
		change_mode = 1;
		////////////
		pic_obj[current_img].fw -= 2;
		pic_obj[current_img].fh -= 2;
	} else if(e.keyCode == 39) {
		////////////
		change_mode = 2;
		////////////
		pic_obj[current_img].a += 2;
	} else if(e.keyCode == 37) {
		////////////
		change_mode = 2;
		////////////
		pic_obj[current_img].a -= 2;
	}

	drawcanvas();
}

function findobj(e) {
	for(var i=0;i<pic_obj.length;i++)
		if((e.clientX - offsetX)  >= pic_obj[i].x && (e.clientX - offsetX) <= (pic_obj[i].x+pic_obj[i].fw) && (e.clientY - offsetY) >= pic_obj[i].y && (e.clientY - offsetY) <= (pic_obj[i].y+pic_obj[i].fh)) {
			current_img = i;
			break;
		}	
}

function createobj(e) {
	
	if((e.clientX - offsetX) > canvas.width-110) {
		current_id = parseInt((e.clientY - offsetY)/100);
		console.log(current_id);
		///////
		csvString += "a," + current_id + "," + pic_obj.length + "\n";
		///////
		pic_obj.push(new object(current_id+1,100,100,0,100,100,100,100));
		drawcanvas();
	}
}

window.onload = function() {
	//ctx.clearRect(0,0,canvas.width,canvas.height);
	ctx.drawImage(img1,canvas.width - 110,0,100,100);
	ctx.drawImage(img2,canvas.width - 110,100,100,100);
	ctx.moveTo(canvas.width - 120,0);
	ctx.lineTo(canvas.width - 120,canvas.height);
	ctx.stroke();
}



</script>

</body>
</html>